<html>
    <head>
        <title></title>
    </head>
    <body>
        <div id = "console">
        </div>
        <script type = "text/javascript" src = "../trialtool/lib/jquery/jquery-1.4.2.min.js">
        </script>
        <script type = "text/javascript" src = "../trialtool/js/ConsoleHelper.js">
        </script>
        <script type = "text/javascript">
        /*Pre Requisites*/
        
        
        if (!window.indexedDB) {
            window.indexedDB = new ActiveXObject("SQLCE.Factory.4.0");
            window.indexedDBSync = new ActiveXObject("SQLCE.FactorySync.4.0");
            
            if (window.JSON) {
                window.indexedDB.json = window.JSON;
                window.indexedDBSync.json = window.JSON;
            }
            else {
                var jsonObject = {
                    parse: function(txt){
                        if (txt === "[]") 
                            return [];
                        if (txt === "{}") 
                            return {};
                        throw {
                            message: "Unrecognized JSON to parse: " + txt
                        };
                    }
                };
                window.indexedDB.json = jsonObject;
                window.indexedDBSync.json = jsonObject;
                
            }
            
            // Add some interface-level constants and methods.
            window.IDBDatabaseException = {
                UNKNOWN_ERR: 0,
                NON_TRANSIENT_ERR: 1,
                NOT_FOUND_ERR: 2,
                CONSTRAINT_ERR: 3,
                DATA_ERR: 4,
                NOT_ALLOWED_ERR: 5,
                SERIAL_ERR: 11,
                RECOVERABLE_ERR: 21,
                TRANSIENT_ERR: 31,
                TIMEOUT_ERR: 32,
                DEADLOCK_ERR: 33
            };
            
            window.IDBKeyRange = {
                SINGLE: 0,
                LEFT_OPEN: 1,
                RIGHT_OPEN: 2,
                LEFT_BOUND: 4,
                RIGHT_BOUND: 8
            };
            
            window.IDBRequest = {
                INITIAL: 0,
                LOADING: 1,
                DONE: 2
            }
            
            window.IDBKeyRange.only = function(value){
                return window.indexedDB.range.only(value);
            };
            
            window.IDBKeyRange.leftBound = function(bound, open){
                return window.indexedDB.range.leftBound(bound, open);
            };
            
            window.IDBKeyRange.rightBound = function(bound, open){
                return window.indexedDB.range.rightBound(bound, open);
            };
            
            window.IDBKeyRange.bound = function(left, right, openLeft, openRight){
                return window.indexedDB.range.bound(left, right, openLeft, openRight);
            };
        }
        
        DAO = {};
        document.write("Trying to open database ...");
        var request = window.indexedDB.open("BookShop", "My Book Shop Database");
        request.onsuccess = function(event){
            document.write("Dataase opened");
            DAO.db = event.result;
            
            DAO.transaction = DAO.db.transaction(["BookList"], 0);
            DAO.objectStore = DAO.transaction.objectStore("BookList");
            document.write("Transaction Created");
            var req = DAO.objectStore.openCursor();
            req.onsuccess = function(e){
                DAO.cursor = e.result;
                document.write("Cursor Ready");
                (function iterateOnCursor(){
                    var moveReq = DAO.cursor.move();
                    document.write("Cursor Moved");
                    moveReq.onsuccess = function(e){
                        if (e.result) {
                            write("Updating", DAO.cursor.value);
                            DAO.cursor.value["new_cursor_property"] = Math.random();
                            var updateReq = DAO.cursor.update(DAO.cursor.value);
                            updateReq.onsuccess = function(e){
                                document.write("Updated ", e.result);
                                iterateOnCursor();
                            };
                            updateReq.onerror = function(e){
                                writeError(e);
                                DAO.transaction.abort();
                            };
                        }
                        else {
                            document.write("Reached end of cursor");
                            DAO.transaction.commit();
                            delete DAO.cursor;
                        }
                    };
                    moveReq.onerror = function(e){
                        writeError(e);
                        DAO.transaction.abort();
                    }
                })();
            }
            
            req.onerror = function(e){
                writeError(e.message);
            }
        };
        </script>
    </body>
</html>
